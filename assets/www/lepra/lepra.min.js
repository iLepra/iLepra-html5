iLepra=function(){var a=18e5,b=null,c=null,d=null,e={c:null,p:null},f={c:null,p:null},g=function(a){var b=/img alt="captcha" src="(.+?)"/g,c=/<input type="hidden" name="logincode" value="(.+?)"/g;iLepra.captchaURL="http://leprosorium.ru"+b.exec(a)[1],iLepra.loginCode=c.exec(a)[1]},h=function(a){a=a.replace(/\n+/g,""),a=a.replace(/\r+/g,""),a=a.replace(/\t+/g,""),iLepra.postVoteWTF=/wtf_vote = '(.+?)'/g.exec(a)[1],iLepra.myStuffWTF=/mythingsHandler.wtf = '(.+?)'/g.exec(a)[1],iLepra.chat.wtf=/chatHandler.wtf = '(.+?)'/g.exec(a)[1],iLepra.username=/<div id="greetings" class="columns_wrapper">.+?<a href=".+?">(.+?)<\/a>/g.exec(a)[1],iLepra.logoutWTF=/name="wtf" value="(.+?)"/g.exec(a)[1],iLepra.userSubLepras=[];var b=/<div class="sub"><strong class="logo"><a href="(.+?)" title="(.*?)"><img src="(.+?)" alt=".+?" \/>.+?<div class="creator">.+?<a href=".*?\/users\/.+?">(.+?)<\/a>/g,c=b.exec(a);while(c!=null){var d={name:c[2],creator:c[4],link:c[1],logo:c[3]};iLepra.userSubLepras.push(d),c=b.exec(a)}},i=function(){return navigator.userAgent.match(/(iPad)|(iPhone)|(iPod)|(Android)|(webOS)|(PlayBook)/i)?!0:!1};return{events:{init:"iLepraInit",ready:"iLepraReady",update:"iLepraUpdate",error:"iLepraError"},config:{loadImages:!0,screenBiggest:0,postIncrement:20,defaultTapEvent:"tap"},isAuthenticated:!1,loginCode:null,captchaURL:null,errorMessage:null,username:null,userSubLepras:null,inboxNewPosts:null,inboxNewComments:null,karma:null,rating:null,voteweight:null,myNewComments:null,myNewPosts:null,latestPosts:null,postCount:null,postVoteWTF:null,myStuffPosts:null,myStuffWTF:null,favouritePosts:null,inboxPosts:null,logoutWTF:null,init:function(){this.config.screenBiggest=window.screen.width>window.screen.height?window.screen.width:window.screen.height,$.get("http://leprosorium.ru",function(a){a.indexOf('<input type="password"')>0?(g(a),iLepra.isAuthenticated=!1):(iLepra.isAuthenticated=!0,h(a)),$(document).trigger(iLepra.events.init)})},tryLogin:function(a){a.logincode=this.loginCode,$.post("http://leprosorium.ru/login/",a,function(a){if(a.indexOf('class="error"')>0){var b=/<div class="error">(.+?)<\/div>/g;iLepra.errorMessage=b.exec(a)[1],g(a),$(document).trigger(iLepra.events.error)}else h(a),$(document).trigger(iLepra.events.ready)})},getNewsCounters:function(){$.ajax({url:"http://leprosorium.ru/api/lepropanel",dataType:"json",error:function(a){var b=$.parseJSON(a.responseText);iLepra.inboxNewPosts=parseInt(b.inboxunreadposts),iLepra.inboxNewComments=parseInt(b.inboxunreadcomms),iLepra.karma=parseInt(b.karma),iLepra.rating=parseInt(b.rating),iLepra.voteweight=parseInt(b.voteweight),iLepra.myNewComments=parseInt(b.myunreadcomms),iLepra.myNewPosts=parseInt(b.myunreadposts),$(document).trigger(iLepra.events.update)}})},getLastPosts:function(c){if(c==null||typeof c=="undefined")c=!1;var d=(new Date).getTime();if(b!=null&&Math.abs(d-b)<a&&iLepra.latestPosts.length>0&&!c){$(document).trigger(iLepra.events.ready);return}iLepra.postCount=0,$.post("http://leprosorium.ru/idxctl/",{from:iLepra.postCount},function(a){b=(new Date).getTime(),a=$.parseJSON(a),iLepra.latestPosts=[],iLepra.util.processJSONPosts(a.posts,iLepra.latestPosts),$(document).trigger(iLepra.events.ready)})},getMorePosts:function(){iLepra.postCount+=42,$.post("http://leprosorium.ru/idxctl/",{from:iLepra.postCount},function(a){a=$.parseJSON(a),iLepra.util.processJSONPosts(a.posts,iLepra.latestPosts),$(document).trigger(iLepra.events.ready)})},switchLayout:function(a){$.post("http://leprosorium.ru/threshold/",{showonindex:a,selected_threshold:"all"},function(){iLepra.getLastPosts(!0)})},getMyStuff:function(b){if(b==null||typeof b=="undefined")b=!1;var d=(new Date).getTime();if(iLepra.myNewComments==e.c&&iLepra.myNewPosts==e.p&&c!=null&&Math.abs(d-c)<a&&iLepra.myStuffPosts.length>0&&!b){$(document).trigger(iLepra.events.ready);return}$.get("http://leprosorium.ru/my/",function(a){e={p:iLepra.myNewPosts,c:iLepra.myNewComments},c=(new Date).getTime(),iLepra.myStuffPosts=[],iLepra.util.processHTMLPosts(a,iLepra.myStuffPosts,undefined),$(document).trigger(iLepra.events.ready)})},getFavourites:function(){if(iLepra.favouritePosts!=null&&iLepra.favouritePosts.length>0){$(document).trigger(iLepra.events.ready);return}$.get("http://leprosorium.ru/my/favourites/",function(a){iLepra.favouritePosts=[],iLepra.util.processHTMLPosts(a,iLepra.favouritePosts,"fav"),$(document).trigger(iLepra.events.ready)})},getInbox:function(b){if(b==null||typeof b=="undefined")b=!1;var c=(new Date).getTime();if(iLepra.inboxNewComments==f.c&&iLepra.inboxNewPosts==f.p&&d!=null&&Math.abs(c-d)<a&&iLepra.inboxPosts.length>0&&!b){$(document).trigger(iLepra.events.ready);return}$.get("http://leprosorium.ru/my/inbox/",function(a){f={p:iLepra.inboxNewPosts,c:iLepra.inboxNewComments},d=(new Date).getTime(),iLepra.inboxPosts=[],iLepra.util.processHTMLPosts(a,iLepra.inboxPosts,"inbox"),$(document).trigger(iLepra.events.ready)})},doLogout:function(){$.post("http://leprosorium.ru/logout/",{wtf:iLepra.logoutWTF},function(){$(document).trigger(iLepra.events.ready)}).error(function(){$(document).trigger(iLepra.events.ready)})}}}(),iLepra.util=function(){return{processHTMLPosts:function(a,b,c){a=a.replace(/\n+/g,""),a=a.replace(/\r+/g,""),a=a.replace(/\t+/g,"");var d=/<div class="post.+?id="(.+?)".+?class="dt">(.+?)<\/div>.+?<a href=".*?\/users\/.+?".*?>(.+?)<\/a>,(.+?)<span>.+?<a href=".*?\/(comments|inbox)\/.+?">(.+?)<\/span>.+?.+?(<div class="vote".+?><em>(.+?)<\/em><\/span>|<\/div>)(<a href="#".+?class="plus(.*?)">.+?<a href="#".+?class="minus(.*?)">|<\/div>)/g,e=d.exec(a);while(e!=null){var f=e[2],g=/img src="(.+?)"/g,h=g.exec(f),i="";if(h!=null){i="http://src.sencha.io/80/80/"+h[1],f=f.replace(h[1],"http://src.sencha.io/"+iLepra.config.screenBiggest+"/"+h[1]),h=g.exec(f);while(h!=null)f=f.replace(e[1],"http://src.sencha.io/"+iLepra.config.screenBiggest+"/"+h[1]),h=g.exec(f)}var j=f.replace(/(<([^>]+)>)/ig," ").substr(0,140);j.length==140&&(j+="..");var k=e[3].split("</a> в "),l=k[1]?k[1].replace(/(<([^>]+)>)/ig,""):"",m=0;e[9]!=null&&e[9].length>0?m=1:e[10]!=null&&e[10].length>0&&(m=-1),f=f.replace(/href="(.+?)"/g,'href="#" data-url="$1"');var n={id:e[1].replace("p",""),body:f,rating:e[8],user:k[0],domain_url:l,when:e[4],comments:e[6].replace(/(<([^>]+)>)/ig,"").replace(/коммента.+?(\s|$)/g,"").replace(/ нов.+/g,""),image:i,text:j,type:c,vote:m};b.push(n),e=d.exec(a)}},processJSONPosts:function(a,b){for(var c in a){var d={},e=/img src="(.+?)"/gi,f=e.exec(a[c].body),g="";if(f!=null){g="http://src.sencha.io/80/80/"+f[1],a[c].body=a[c].body.replace(f[1],"http://src.sencha.io/"+iLepra.config.screenBiggest+"/"+f[1]),f=e.exec(a[c].body);while(f!=null)f[1].indexOf("http://")!=-1&&(a[c].body=a[c].body.replace(f[1],"http://src.sencha.io/"+iLepra.config.screenBiggest+"/"+f[1])),f=e.exec(a[c].body)}var h=a[c].body.replace(/(<([^>]+)>)/g," ").substr(0,140);h.length==140&&(h+="..");var i=a[c].body.replace(/href="(.+?)"/g,'href="#" data-url="$1"');d.id=a[c].id,d.body=i,d.rating=a[c].rating,d.domain_url=a[c].domain_url,d.image=g,d.text=h,d.user=a[c].login,d.comments=a[c].comm_count+" / "+a[c].unread,d.wrote=(a[c].gender==1?"Написал ":"Написала ")+a[c].user_rank+" "+a[c].login,d.when=a[c].textdate+" в "+a[c].posttime,d.vote=parseInt(a[c].user_vote),b.indexOf(d)==-1&&b.push(d)}}}}(),iLepra.ui=function(){return{showError:function(a){$("<div class='errorMessage ui-overlay-shadow ui-body-e ui-corner-all'>"+a+"</div>").css({top:$(window).scrollTop()+100}).appendTo($.mobile.activePage).delay(1200).fadeOut(800,function(){$(this).remove()})}}}(),iLepra.post=function(){return{current:null,comments:null,newComments:null,getComments:function(a,b){typeof a=="undefined"&&(a=iLepra.post.current.id),typeof b=="undefined"&&(b=iLepra.post.current.type);var c;if(b=="inbox")c="http://leprosorium.ru/my/inbox/"+a;else{var d="leprosorium.ru";iLepra.post.current.domain_url.length>0&&(d=iLepra.post.current.domain_url),c="http://"+d+"/comments/"+a}$.get(c,function(a){a=a.replace(/\n+/g,""),a=a.replace(/\r+/g,""),a=a.replace(/\t+/g,""),iLepra.post.comments=[],iLepra.post.newComments=[];var b=/wtf_vote = '(.+?)'/gi.exec(a);iLepra.post.current.wtf={comment:/commentsHandler.wtf = '(.+?)'/g.exec(a)[1],vote:b!=null?b[1]:null};var c=/<div id="(.+?)" class="post tree(.+?)"><div class="dt">(.+?)<\/div>.+?<a href=".*?\/users\/.+?">(.+?)<\/a>,(.+?)<span>.+?(<div class="vote".+?><em>(.+?)<\/em><\/span>|<\/div>)(<a href="#".+?class="plus(.*?)">.+?<a href="#".+?class="minus(.*?)">|<\/div>)/g;a=a.substr(a.indexOf('id="js-commentsHolder"'));var d=c.exec(a);while(d!=null){var e=d[3],f=/img src="(.+?)"/g,g=f.exec(e);while(g!=null)e=e.replace(g[1],"http://src.sencha.io/"+iLepra.config.screenBiggest+"/"+g[1]),g=f.exec(e);var h=0;d[9]!=null&&d[9].length>0?h=1:d[10]!=null&&d[10].length>0&&(h=-1);var i=0;g=/indent_(.+?) /.exec(d[2]),g!=null&&(i=g[1]),i>15&&(i=15),e=e.replace(/<p.*?>/gi,""),e=e.replace(/<\/p>/gi,""),e=e.replace(/<nonimg/ig,"<img");var j="";i!=0&&(j='style="margin-left: '+5*i+"px; border-left: 2px solid "+borderColors[i]+'"');var k=d[2].indexOf("new")!=-1?1:0,l={id:d[1],isNew:k,indent:i,text:e,rating:d[7],user:d[4],when:d[5],vote:h,newClass:k?'new" data-theme="d':"",style:j};iLepra.post.comments.push(l),l.isNew&&iLepra.post.newComments.push(l),d=c.exec(a)}$(document).trigger(iLepra.events.ready)})},addComment:function(a,b){var c="http://";iLepra.post.current.domain_url!=""&&iLepra.post.current.type!="inbox"?c+=iLepra.post.current.domain_url:c+="leprosorium.ru",c+="/commctl/";var d={wtf:iLepra.post.current.wtf.comment,pid:iLepra.post.current.id,comment:a};typeof b!="undefined"&&b!=null&&(d.replyto=b),$.post(c,d,function(c){c=$.parseJSON(c);if(c.status=="ERR")$(document).trigger(iLepra.events.error);else{if(typeof b=="undefined"||b==null)iLepra.post.comments.push({id:c.new_comment.comment_id,isNew:1,indent:0,text:a,rating:0,user:c.new_comment.user_login,when:c.new_comment.date+" в "+c.new_comment.time,vote:0});else{var d,e,f=iLepra.post.comments.length;for(d=0;d<f;d++){e=iLepra.post.comments[d];if(e.id==c.new_comment.replyto_id){iLepra.post.comments.splice(d+1,0,{id:c.new_comment.comment_id,isNew:1,indent:(parseInt(e.indent)+1).toString(),text:a,rating:0,user:c.new_comment.user_login,when:c.new_comment.date+" в "+c.new_comment.time,vote:0});break}}}$(document).trigger(iLepra.events.ready)}})},voteComment:function(a,b){var c="http://";iLepra.post.current.domain_url!=""?c+=iLepra.post.current.domain_url:c+="leprosorium.ru",c+="/rate/";var d={type:0,wtf:iLepra.post.current.wtf.vote,post_id:iLepra.post.current.id,id:a,value:b};$.post(c,d,function(a){})},votePost:function(a,b){var c="http://";iLepra.post.current.domain_url!=""?c+=iLepra.post.current.domain_url:c+="leprosorium.ru",c+="/rate/";var d={type:1,wtf:iLepra.postVoteWTF,id:a,value:b};$.post(c,d,function(a){})}}}(),iLepra.profile=function(){return{data:null,getProfile:function(a){var b="http://leprosorium.ru/users/"+a;$.get(b,function(b){b=b.replace(/\n+/g,""),b=b.replace(/\r+/g,""),b=b.replace(/\t+/g,"");var c=/<table class="userpic"><tbody><tr><td><img src="(.+?)".+?\/>/g.exec(b);c?c=c[1]:c="";var d=/<div class="userregisterdate">(.+?)<\/div>/g.exec(b)[1].replace(/\./g,"").split(", "),e=d[0],f=d[1],g=/<div class="userbasicinfo"><h3>(.+?)<\/h3>/g.exec(b)[1],h=/<div class="userego">(.+?)<\/div>/g.exec(b)[1],i=/<span class="rating" id="js-user_karma".+?><em>(.+?)<\/em>/g.exec(b)[1],j=/<div class="userstat userrating">(.+?)<\/div>/g.exec(b),k=/<div class="userstat uservoterate">Вес голоса&nbsp;&#8212; (.+?)<br.*?>Голосов в день&nbsp;&#8212; (.+?)<\/div>/g.exec(b),l=j[1].replace(/(<([^>]+)>)/ig," "),m="Вес голоса&nbsp;&#8212; "+k[1]+",<br>Голосов в день&nbsp;&#8212; "+k[2],n=/<div class="userstory">(.+?)<\/div>/g.exec(b);n!=null?n=n[1]:n="";var o=/<div class="usercontacts">(.+?)<\/div>/g.exec(b)[1].split(/<br.*?>/);iLepra.profile.data={username:a,userpic:c,number:e,regDate:f,fullName:g,location:h,karma:i,userstat:l,votestat:m,contacts:o,description:n},$(document).trigger(iLepra.events.ready)})}}}(),iLepra.sub=function(){return{list:null,posts:null,fetch:!0,postCount:0,getList:function(a){$.get("http://leprosorium.ru/underground/",function(a){a=a.replace(/\n+/g,""),a=a.replace(/\r+/g,""),a=a.replace(/\t+/g,""),iLepra.sub.list=[];var b=/<strong class="jj_logo"><a href="(.+?)"><img src="(.+?)" alt="(.*?)" \/>.+?<a href=".*?\/users\/.+?">(.+?)<\/a>/g,c=b.exec(a);while(c!=null){var d=c[3]?c[3]:c[1],e={name:d,creator:c[4],link:c[1],logo:c[2]};iLepra.sub.list.push(e),c=b.exec(a)}$(document).trigger(iLepra.events.ready)})},getPosts:function(a){iLepra.sub.postCount=0,$.post(a+"/idxctl/",{from:iLepra.sub.postCount},function(a){a=$.parseJSON(a),iLepra.sub.posts=[],iLepra.util.processJSONPosts(a.posts,iLepra.sub.posts),$(document).trigger(iLepra.events.ready)})},getMorePosts:function(a){iLepra.sub.postCount+=42,$.post(a+"/idxctl/",{from:iLepra.sub.postCount},function(a){a=$.parseJSON(a),iLepra.util.processJSONPosts(a.posts,iLepra.sub.posts),$(document).trigger(iLepra.events.ready)})}}}(),iLepra.gov=function(){return{president:null,time:null,ministers:null,banned:null,getCurrent:function(){$.get("http://leprosorium.ru/democracy/",function(a){a=a.replace(/\n+/g,""),a=a.replace(/\r+/g,""),a=a.replace(/\t+/g,"");var b=/<div id="president"><a href=".+?">(.+?)<\/a><p>.+?<br \/>(.+?)<\/p><\/div>/g,c=b.exec(a);iLepra.gov.president=c[1],iLepra.gov.time=c[2],$(document).trigger(iLepra.events.ready)})}}}(),iLepra.chat=function(){var a=function(){var a="";if(iLepra.chat.messages.length>0){var b=0;for(var c in iLepra.chat.messages)parseInt(iLepra.chat.messages[c].id)>b&&(b=parseInt(iLepra.chat.messages[c].id));b!=0&&(a=b)}return a};return{messages:[],wtf:null,defaultKey:"leprosorium.ru/",getMessages:function(){var b=a(),c={wtf:iLepra.chat.wtf,key:iLepra.chat.defaultKey,last:b};$.post("http://leprosorium.ru/chatctl/",c,function(a){var b=$.parseJSON(a);for(var c in b.messages)iLepra.chat.messages.indexOf(b.messages[c])==-1&&iLepra.chat.messages.push(b.messages[c]);$(document).trigger(iLepra.events.ready)})},sendMessage:function(b){var c=a(),d={wtf:iLepra.chat.wtf,key:iLepra.chat.defaultKey,last:c,body:b};$.post("http://leprosorium.ru/chatctl/",d,function(a){var b=$.parseJSON(a);for(var c in b.messages)iLepra.chat.messages.indexOf(b.messages[c])==-1&&iLepra.chat.messages.push(b.messages[c]);$(document).trigger(iLepra.events.ready)})}}}()